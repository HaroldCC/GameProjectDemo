add_requires("spdlog", "doctest", "toml++", "asio", "protobuf-cpp", {system=false})

target("Common")
    set_kind("static")
    add_packages("spdlog", "doctest", "toml++", "asio")
    -- add_cxflags("/P")
    add_includedirs("src")
    -- add_files("src/Common/*.hpp")
    -- add_files("src/Common/*.ixx", "src/net/*.ixx", "src/**.cpp")
    ExterRule()

target("tests")
    set_kind("binary")
    add_packages("spdlog", "doctest", "toml++", "asio")
    add_deps("Common")
    add_includedirs("src")
    -- add_rules("buildproto")
    -- add_rules("protobuf.cpp")
    -- add_files("src/protobuf/**.proto")
    add_headerfiles("src/tests/*.h")
    add_files("src/tests/*.cpp|test_session.cpp")
    -- add_files("src/tests/test.cpp")
    ExterRule()

target("testServer")
    set_kind("binary")
    add_packages("spdlog", "doctest", "toml++", "asio")
    add_deps("Common")

    add_includedirs("../thirdparty/protobuf/include/", "../protobufout", "../Server/src", "src/proto/")

    before_build(function (target) 
        os.execv([[./thirdparty/protobuf/bin/protoc.exe ./Server/src/proto/*.proto --cpp_out=./protobufout]])
    end)

    -- add_rules("buildproto")
    add_headerfiles("src/proto/*.h")
    add_files("../protobufout/**.cc")
    -- add_rules("protobuf.cpp")
    -- add_files("src/protobuf/*.proto")
    -- add_files("src/protobuf/*.proto", {rules="protobuf.cpp", proto_rootdir="protobuf", proto_public=true})
    add_files("src/tests/test_session.cpp")
    ExterRule()
